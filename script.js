let greyscale = false;
let prev_binary_length = document.getElementById('binary').value.length;
refreshUI();

function increment() {
    document.getElementById('lineLength').value++;
}

function decrement() {
    document.getElementById('lineLength').value--;
}

function refreshUI() {
    updateBinaryDetails();
    generateGrids();
}

function updateBinaryDetails() {
    greyscale = document.getElementById('greyscale').checked;
    let binary = document.getElementById('binary').value;
    let length = binary.length;
    document.getElementById('binaryLength').innerHTML = length;
    let primeFactors = getPrimeFactors(length);
    document.getElementById('primeFactors').innerHTML = primeFactors.map(p => `<span class="clickable" onclick="setLineLength(${p}); refreshUI()">${p}</span>`).join(", ");

    // if length is updating, and line length value isnt set, then choose the first prime as the default number for line length
    if (prev_binary_length !== length && document.getElementById('lineLength').value.length === 0) {
        setLineLength(primeFactors[0]);
    }

    // update to be current length
    prev_binary_length = length;
}

function autofill1974() {
    document.getElementById('binary').value = "00000010101010000000000001010000010100000001001000100010001001011001010101010101010100100100000000000000000000000000000000000001100000000000000000001101000000000000000000011010000000000000000001010100000000000000000011111000000000000000000000000000000001100001110001100001100010000000000000110010000110100011000110000110101111101111101111101111100000000000000000000000000100000000000000000100000000000000000000000000001000000000000000001111110000000000000111110000000000000000000000011000011000011100011000100000001000000000100001101000011000111001101011111011111011111011111000000000000000000000000001000000110000000001000000000001100000000000000010000011000000000011111100000110000001111100000000001100000000000001000000001000000001000001000000110000000100000001100001100000010000000000110001000011000000000000000110011000000000000011000100001100000000011000011000000100000001000000100000000100000100000001100000000100010000000011000000001000100000000010000000100000100000001000000010000000100000000000011000000000110000000011000000000100011101011000000000001000000010000000000000010000011111000000000000100001011101001011011000000100111001001111111011100001110000011011100000000010100000111011001000000101000001111110010000001010000011000000100000110110000000000000000000000000000000000011100000100000000000000111010100010101010101001110000000001010101000000000000000010100000000000000111110000000000000000111111111000000000000111000000011100000000011000000000001100000001101000000000101100000110011000000011001100001000101000001010001000010001001000100100010000000010001010001000000000000100001000010000000000001000000000100000000000000100101000000000001111001111101001111000";
    refreshUI();
}

function autofill2001() {
    document.getElementById('binary').value = "0000001010101000000000000101000001010000000100100010001000100101100101010101010101010010010000000000000000000000000000000000000111000000000000000000110110000000000000000001101100000000000000000101001000000000000000001111110000000000000000000000000000000110000111000110000110001000000000000011001000011010001100011000011010111110111110111110111110000000000000000000000000010000000000000000010000000000000000000000000000100000000000000000111111000000000000011111000000000000000000000001100001100001110001100010000000100000000010000110100001100011100110101111101111101111101111100000000000000000000000000100000001100000000100000000000011000000000000001000000110000000001111110000001100000111110000000000011000000000000000000000010000000000000100000001100000011000000100000011000011000000000110000010011000000000000011001100001100000000000000001000000110000000001100110000000010000001100001100000011000000100000011000011000000010000000110011000000001000000000100001100000010000000010000000110000010000000000000000010000010000011100000011000100011001111100011000001000001011111011000000010000000101010000000000100000000111000101101100000000000100000111111101110000011100001101110000000001010100011101101000000000100000111111010000000010100001100000100000000000000000000000000000000001000000000011000001010101000000000110101000000100101010100000000000000001010000000000000000000000000000001001000000000100100000001100000000000110000010011000111110001100100011001010000010100110000110011000000011001100010011101001001011100100000000010101010000000001001110100100101110010001100110000000110011000011001010000010100110001001100011111000110010000011000000000001100000001000100101000000100010000001111101001000001"
    refreshUI();
}

function setLineLength(value) {
    document.getElementById('lineLength').value = value;
}

function getPrimeFactors(n) {
    let factors = [];
    for (let i = 2; i <= n; i++) {
        while ((n % i) === 0) {
            factors.push(i);
            n /= i;
        }
    }
    return factors;
}

function generateGrids() {
    let binary = document.getElementById('binary').value;
    let lineLength = document.getElementById('lineLength').value;
    if (lineLength > 0) {
        generateGrid(binary, lineLength, 'grid');
        generateGrid(reverseEachLine(binary, lineLength), lineLength, 'reverseGrid');
    } else {
        clearGrids();
    }
}

function clearGrids() {
    document.getElementById('grid').innerHTML = "";
    document.getElementById('reverseGrid').innerHTML = "";
}

function reverseEachLine(binary, lineLength) {
    let lines = [];
    while(binary.length) {
        let line = binary.slice(0, lineLength);
        binary = binary.slice(lineLength);
        lines.push(line.split("").reverse().join(""));
    }
    return lines.join("");
}

function generateGrid(binary, lineLength, elementId) {
    let grid = document.getElementById(elementId);
    grid.innerHTML = "";
    for(let i = 0; i < binary.length; i++) {
        let pixel = document.createElement("div");
        pixel.classList.add("pixel");
        let value = binary[i];
        if(greyscale) {
            let grey = Math.floor(255 - (Number(value) * 28.3));
            pixel.style.backgroundColor = `rgb(${grey},${grey},${grey})`;
        } else {
            if(value === '1') {
                pixel.classList.add("black");
            } else {
                pixel.classList.add("white");
            }
        }
        grid.appendChild(pixel);
        if((i + 1) % lineLength == 0) {
            let breakElement = document.createElement("div");
            breakElement.style.clear = "both";
            grid.appendChild(breakElement);
        }
    }
}
